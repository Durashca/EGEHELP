System.register("chunks:///_virtual/builtin-pipeline-settings.ts",["./rollupPluginModLoBabelHelpers.js","cc","./builtin-pipeline-types.ts"],(function(t){var e,o,i,r,s,n,a,p,l,g,c,y,m,b,d;return{setters:[function(t){e=t.applyDecoratedDescriptor,o=t.initializerDefineProperty},function(t){i=t.cclegacy,r=t.Camera,s=t.CCBoolean,n=t.CCInteger,a=t.CCFloat,p=t.Material,l=t.Texture2D,g=t._decorator,c=t.Component,y=t.rendering},function(t){m=t.BloomType,b=t.fillRequiredPipelineSettings,d=t.makePipelineSettings}],execute:function(){var h,u,P,_,M,S,w,O,f,E,G,D,B,C,A,j,F,x,v,k,R,T,I,L,X,z,H,q,Y,N,Q,Z,J;i._RF.push({},"de1c2EHcMhAIYRZY5nyTQHG","builtin-pipeline-settings",void 0);const{ccclass:K,disallowMultiple:U,executeInEditMode:V,menu:W,property:$,requireComponent:tt,type:et}=g;t("BuiltinPipelineSettings",(h=K("BuiltinPipelineSettings"),u=W("Rendering/BuiltinPipelineSettings"),P=tt(r),_=$(s),M=$({displayName:"Editor Preview (Experimental)",type:s}),S=$({group:{id:"MSAA",name:"Multisample Anti-Aliasing"},type:s}),w=$({group:{id:"MSAA",name:"Multisample Anti-Aliasing",style:"section"},type:n,range:[2,4,2]}),O=$({group:{id:"ShadingScale",name:"ShadingScale",style:"section"},type:s}),f=$({tooltip:"i18n:postprocess.shadingScale",group:{id:"ShadingScale",name:"ShadingScale"},type:a,range:[.01,4,.01],slide:!0}),E=$({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:s}),G=et(m),D=$({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"}}),B=$({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:p}),C=$({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:p}),A=$({tooltip:"i18n:bloom.enableAlphaMask",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:s}),j=$({tooltip:"i18n:bloom.iterations",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:n,range:[1,6,1],slide:!0}),F=$({tooltip:"i18n:bloom.threshold",group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"},type:a,min:0}),x=et(a),v=$({group:{id:"Bloom",name:"Bloom (PostProcessing)",style:"section"}}),k=$({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:s}),R=$({group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:p}),T=$({tooltip:"i18n:color_grading.contribute",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:a,range:[0,1,.01],slide:!0}),I=$({tooltip:"i18n:color_grading.originalMap",group:{id:"Color Grading",name:"ColorGrading (LDR) (PostProcessing)",style:"section"},type:l}),L=$({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:s}),X=$({group:{id:"FXAA",name:"Fast Approximate Anti-Aliasing (PostProcessing)",style:"section"},type:p}),z=$({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:s}),H=$({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:p}),q=$({group:{id:"FSR",name:"FidelityFX Super Resolution",style:"section"},type:a,range:[0,1,.01],slide:!0}),Y=$({group:{id:"ToneMapping",name:"ToneMapping",style:"section"},type:p}),h(N=u(N=P(N=U(N=V((Z=e((Q=class extends c{constructor(...t){super(...t),o(this,"_settings",Z,this),o(this,"_editorPreview",J,this)}getPipelineSettings(){return this._settings}onEnable(){b(this._settings);this.getComponent(r).camera.pipelineSettings=this._settings}onDisable(){const t=this.getComponent(r).camera;t&&(t.pipelineSettings=null)}get editorPreview(){return this._editorPreview}set editorPreview(t){this._editorPreview=t}_tryEnableEditorPreview(){void 0!==y&&(this._editorPreview?y.setEditorPipelineSettings(this._settings):this._disableEditorPreview())}_disableEditorPreview(){if(void 0===y)return;y.getEditorPipelineSettings()===this._settings&&y.setEditorPipelineSettings(null)}get MsaaEnable(){return this._settings.msaa.enabled}set MsaaEnable(t){this._settings.msaa.enabled=t}set msaaSampleCount(t){t=2**Math.ceil(Math.log2(Math.max(t,2))),t=Math.min(t,4),this._settings.msaa.sampleCount=t}get msaaSampleCount(){return this._settings.msaa.sampleCount}set shadingScaleEnable(t){this._settings.enableShadingScale=t}get shadingScaleEnable(){return this._settings.enableShadingScale}set shadingScale(t){this._settings.shadingScale=t}get shadingScale(){return this._settings.shadingScale}set bloomEnable(t){this._settings.bloom.enabled=t}get bloomEnable(){return this._settings.bloom.enabled}set bloomType(t){this._settings.bloom.type=t}get bloomType(){return this._settings.bloom.type}set kawaseBloomMaterial(t){this._settings.bloom.kawaseFilterMaterial!==t&&(this._settings.bloom.kawaseFilterMaterial=t)}get kawaseBloomMaterial(){return this._settings.bloom.kawaseFilterMaterial}set mipmapBloomMaterial(t){this._settings.bloom.mipmapFilterMaterial!==t&&(this._settings.bloom.mipmapFilterMaterial=t)}get mipmapBloomMaterial(){return this._settings.bloom.mipmapFilterMaterial}set bloomEnableAlphaMask(t){this._settings.bloom.enableAlphaMask=t}get bloomEnableAlphaMask(){return this._settings.bloom.enableAlphaMask}set bloomIterations(t){this._settings.bloom.iterations=t}get bloomIterations(){return this._settings.bloom.iterations}set bloomThreshold(t){this._settings.bloom.threshold=t}get bloomThreshold(){return this._settings.bloom.threshold}set bloomIntensity(t){this._settings.bloom.intensity=t}get bloomIntensity(){return this._settings.bloom.intensity}set colorGradingEnable(t){this._settings.colorGrading.enabled=t}get colorGradingEnable(){return this._settings.colorGrading.enabled}set colorGradingMaterial(t){this._settings.colorGrading.material!==t&&(this._settings.colorGrading.material=t)}get colorGradingMaterial(){return this._settings.colorGrading.material}set colorGradingContribute(t){this._settings.colorGrading.contribute=t}get colorGradingContribute(){return this._settings.colorGrading.contribute}set colorGradingMap(t){this._settings.colorGrading.colorGradingMap=t}get colorGradingMap(){return this._settings.colorGrading.colorGradingMap}set fxaaEnable(t){this._settings.fxaa.enabled=t}get fxaaEnable(){return this._settings.fxaa.enabled}set fxaaMaterial(t){this._settings.fxaa.material!==t&&(this._settings.fxaa.material=t)}get fxaaMaterial(){return this._settings.fxaa.material}set fsrEnable(t){this._settings.fsr.enabled=t}get fsrEnable(){return this._settings.fsr.enabled}set fsrMaterial(t){this._settings.fsr.material!==t&&(this._settings.fsr.material=t)}get fsrMaterial(){return this._settings.fsr.material}set fsrSharpness(t){this._settings.fsr.sharpness=t}get fsrSharpness(){return this._settings.fsr.sharpness}set toneMappingMaterial(t){this._settings.toneMapping.material!==t&&(this._settings.toneMapping.material=t)}get toneMappingMaterial(){return this._settings.toneMapping.material}}).prototype,"_settings",[$],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return d()}}),J=e(Q.prototype,"_editorPreview",[_],{configurable:!0,enumerable:!0,writable:!0,initializer:function(){return!1}}),e(Q.prototype,"editorPreview",[M],Object.getOwnPropertyDescriptor(Q.prototype,"editorPreview"),Q.prototype),e(Q.prototype,"MsaaEnable",[S],Object.getOwnPropertyDescriptor(Q.prototype,"MsaaEnable"),Q.prototype),e(Q.prototype,"msaaSampleCount",[w],Object.getOwnPropertyDescriptor(Q.prototype,"msaaSampleCount"),Q.prototype),e(Q.prototype,"shadingScaleEnable",[O],Object.getOwnPropertyDescriptor(Q.prototype,"shadingScaleEnable"),Q.prototype),e(Q.prototype,"shadingScale",[f],Object.getOwnPropertyDescriptor(Q.prototype,"shadingScale"),Q.prototype),e(Q.prototype,"bloomEnable",[E],Object.getOwnPropertyDescriptor(Q.prototype,"bloomEnable"),Q.prototype),e(Q.prototype,"bloomType",[G,D],Object.getOwnPropertyDescriptor(Q.prototype,"bloomType"),Q.prototype),e(Q.prototype,"kawaseBloomMaterial",[B],Object.getOwnPropertyDescriptor(Q.prototype,"kawaseBloomMaterial"),Q.prototype),e(Q.prototype,"mipmapBloomMaterial",[C],Object.getOwnPropertyDescriptor(Q.prototype,"mipmapBloomMaterial"),Q.prototype),e(Q.prototype,"bloomEnableAlphaMask",[A],Object.getOwnPropertyDescriptor(Q.prototype,"bloomEnableAlphaMask"),Q.prototype),e(Q.prototype,"bloomIterations",[j],Object.getOwnPropertyDescriptor(Q.prototype,"bloomIterations"),Q.prototype),e(Q.prototype,"bloomThreshold",[F],Object.getOwnPropertyDescriptor(Q.prototype,"bloomThreshold"),Q.prototype),e(Q.prototype,"bloomIntensity",[x,v],Object.getOwnPropertyDescriptor(Q.prototype,"bloomIntensity"),Q.prototype),e(Q.prototype,"colorGradingEnable",[k],Object.getOwnPropertyDescriptor(Q.prototype,"colorGradingEnable"),Q.prototype),e(Q.prototype,"colorGradingMaterial",[R],Object.getOwnPropertyDescriptor(Q.prototype,"colorGradingMaterial"),Q.prototype),e(Q.prototype,"colorGradingContribute",[T],Object.getOwnPropertyDescriptor(Q.prototype,"colorGradingContribute"),Q.prototype),e(Q.prototype,"colorGradingMap",[I],Object.getOwnPropertyDescriptor(Q.prototype,"colorGradingMap"),Q.prototype),e(Q.prototype,"fxaaEnable",[L],Object.getOwnPropertyDescriptor(Q.prototype,"fxaaEnable"),Q.prototype),e(Q.prototype,"fxaaMaterial",[X],Object.getOwnPropertyDescriptor(Q.prototype,"fxaaMaterial"),Q.prototype),e(Q.prototype,"fsrEnable",[z],Object.getOwnPropertyDescriptor(Q.prototype,"fsrEnable"),Q.prototype),e(Q.prototype,"fsrMaterial",[H],Object.getOwnPropertyDescriptor(Q.prototype,"fsrMaterial"),Q.prototype),e(Q.prototype,"fsrSharpness",[q],Object.getOwnPropertyDescriptor(Q.prototype,"fsrSharpness"),Q.prototype),e(Q.prototype,"toneMappingMaterial",[Y],Object.getOwnPropertyDescriptor(Q.prototype,"toneMappingMaterial"),Q.prototype),N=Q))||N)||N)||N)||N)||N));i._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline-types.ts",["cc"],(function(e){var a,l,n;return{setters:[function(e){a=e.cclegacy,l=e.ccenum,n=e.gfx}],execute:function(){e({fillRequiredBloom:d,fillRequiredColorGrading:p,fillRequiredFSR:c,fillRequiredFXAA:f,fillRequiredHBAO:function(e){void 0===e.enabled&&(e.enabled=!1);void 0===e.radiusScale&&(e.radiusScale=1);void 0===e.angleBiasDegree&&(e.angleBiasDegree=10);void 0===e.blurSharpness&&(e.blurSharpness=3);void 0===e.aoSaturation&&(e.aoSaturation=1);void 0===e.needBlur&&(e.needBlur=!1)},fillRequiredMSAA:t,fillRequiredPipelineSettings:function(e){e.msaa?t(e.msaa):e.msaa=r();void 0===e.enableShadingScale&&(e.enableShadingScale=!1);void 0===e.shadingScale&&(e.shadingScale=.5);e.bloom?d(e.bloom):e.bloom=u();e.toneMapping?v(e.toneMapping):e.toneMapping={material:null};e.colorGrading?p(e.colorGrading):e.colorGrading={enabled:!1,material:null,contribute:1,colorGradingMap:null};e.fsr?c(e.fsr):e.fsr={enabled:!1,material:null,sharpness:.8};e.fxaa?f(e.fxaa):e.fxaa={enabled:!1,material:null}},fillRequiredToneMapping:v,makeBloom:u,makeColorGrading:s,makeFSR:m,makeFXAA:b,makeHBAO:function(){return{enabled:!1,radiusScale:1,angleBiasDegree:10,blurSharpness:3,aoSaturation:1,needBlur:!1}},makeMSAA:r,makePipelineSettings:function(){return{msaa:r(),enableShadingScale:!1,shadingScale:.5,bloom:u(),toneMapping:{material:null},colorGrading:{enabled:!1,material:null,contribute:1,colorGradingMap:null},fsr:{enabled:!1,material:null,sharpness:.8},fxaa:{enabled:!1,material:null}}},makeToneMapping:g}),a._RF.push({},"cbf30kCUX9A3K+QpVC6wnzx","builtin-pipeline-types",void 0);const{SampleCount:i}=n;function r(){return{enabled:!1,sampleCount:i.X4}}function t(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.sampleCount&&(e.sampleCount=i.X4)}let o=e("BloomType",function(e){return e[e.KawaseDualFilter=0]="KawaseDualFilter",e[e.MipmapFilter=1]="MipmapFilter",e}({}));function u(){return{enabled:!1,type:o.KawaseDualFilter,material:null,kawaseFilterMaterial:null,mipmapFilterMaterial:null,enableAlphaMask:!1,iterations:3,threshold:.8,intensity:1}}function d(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.type&&(e.type=o.KawaseDualFilter),void 0===e.material&&(e.material=null),void 0===e.kawaseFilterMaterial&&(e.kawaseFilterMaterial=e.material||null),void 0===e.mipmapFilterMaterial&&(e.mipmapFilterMaterial=null),void 0===e.enableAlphaMask&&(e.enableAlphaMask=!1),void 0===e.iterations&&(e.iterations=3),void 0===e.threshold&&(e.threshold=.8),void 0===e.intensity&&(e.intensity=1)}function s(){return{enabled:!1,material:null,contribute:1,colorGradingMap:null}}function p(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.contribute&&(e.contribute=1),void 0===e.colorGradingMap&&(e.colorGradingMap=null)}function m(){return{enabled:!1,material:null,sharpness:.8}}function c(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null),void 0===e.sharpness&&(e.sharpness=.8)}function b(){return{enabled:!1,material:null}}function f(e){void 0===e.enabled&&(e.enabled=!1),void 0===e.material&&(e.material=null)}function g(){return{material:null}}function v(e){void 0===e.material&&(e.material=null)}l(o),a._RF.pop()}}}));

System.register("chunks:///_virtual/builtin-pipeline.ts",["cc","./builtin-pipeline-types.ts"],(function(e){var a,t,i,s,o,n,r,d,l,h,c,p,g,m,u,S,_,w;return{setters:[function(e){a=e.cclegacy,t=e.Vec2,i=e.Vec4,s=e.gfx,o=e.Vec3,n=e.macro,r=e.rendering,d=e.assert,l=e.renderer,h=e.clamp,c=e.Material,p=e.Layers,g=e.PipelineEventType,m=e.geometry,u=e.sys,S=e.pipeline},function(e){_=e.makePipelineSettings,w=e.BloomType}],execute:function(){e("getPingPongRenderTarget",v),a._RF.push({},"ff9b0GZzgRM/obMbHGfCNbk","builtin-pipeline",void 0);const{AABB:b,Sphere:P,intersect:f}=m,{ClearFlagBit:T,Color:R,Format:M,FormatFeatureBit:E,LoadOp:C,StoreOp:x,TextureType:A,Viewport:L}=s,{scene:D}=l,{CameraUsage:F,CSMLevel:N,LightType:O}=D;function B(e){return!!(e.clearFlag&(T.COLOR|T.STENCIL<<1))}function Q(e,a,t,i,s,o){e.shadowFixedArea||e.csmLevel===N.LEVEL_1?(s.left=0,s.top=0,s.width=Math.trunc(a),s.height=Math.trunc(t)):(s.left=Math.trunc(i%2*.5*a),s.top=o>0?Math.trunc(.5*(1-Math.floor(i/2))*t):Math.trunc(.5*Math.floor(i/2)*t),s.width=Math.trunc(.5*a),s.height=Math.trunc(.5*t)),s.left=Math.max(0,s.left),s.top=Math.max(0,s.top),s.width=Math.max(1,s.width),s.height=Math.max(1,s.height)}class y{constructor(){this.isWeb=!1,this.isWebGL1=!1,this.isWebGL2=!1,this.isWebGPU=!1,this.isMobile=!1,this.isHDR=!1,this.useFloatOutput=!1,this.toneMappingType=0,this.shadowEnabled=!1,this.shadowMapFormat=M.R32F,this.shadowMapSize=new t(1,1),this.usePlanarShadow=!1,this.screenSpaceSignY=1,this.supportDepthSample=!1,this.mobileMaxSpotLightShadowMaps=1,this.platform=new i(0,0,0,0)}}function z(e,a){const t=E.SAMPLED_TEXTURE|E.LINEAR_FILTER,i=e.device;a.isWeb=!u.isNative,a.isWebGL1=i.gfxAPI===s.API.WEBGL,a.isWebGL2=i.gfxAPI===s.API.WEBGL2,a.isWebGPU=i.gfxAPI===s.API.WEBGPU,a.isMobile=u.isMobile,a.isHDR=e.pipelineSceneData.isHDR,a.useFloatOutput=e.getMacroBool("CC_USE_FLOAT_OUTPUT"),a.toneMappingType=e.pipelineSceneData.postSettings.toneMappingType;const o=e.pipelineSceneData.shadows;a.shadowEnabled=o.enabled,a.shadowMapFormat=S.supportsR32FloatTexture(e.device)?M.R32F:M.RGBA8,a.shadowMapSize.set(o.size),a.usePlanarShadow=o.enabled&&o.type===l.scene.ShadowType.Planar,a.screenSpaceSignY=e.device.capabilities.screenSpaceSignY,a.supportDepthSample=(e.device.getFormatFeatures(M.DEPTH_STENCIL)&t)===t;const n=i.capabilities.screenSpaceSignY;a.platform.x=a.isMobile?1:0,a.platform.w=.5*n+.5<<1|.5*i.capabilities.clipSpaceSignY+.5}e("PipelineConfigs",y);const H=_();class I{constructor(){this.settings=H,this.isMainGameWindow=!1,this.renderWindowId=0,this.colorName="",this.depthStencilName="",this.enableFullPipeline=!1,this.enableProfiler=!1,this.remainingPasses=0,this.enableShadingScale=!1,this.shadingScale=1,this.nativeWidth=1,this.nativeHeight=1,this.width=1,this.height=1,this.enableHDR=!1,this.radianceFormat=s.Format.RGBA8,this.copyAndTonemapMaterial=null,this.enableStoreSceneDepth=!1}}e("CameraConfigs",I);const W=new R(0,0,0,0);function G(e,a,t,i){d(!!t.copyAndTonemapMaterial);const s=e.addRenderPass(t.nativeWidth,t.nativeHeight,"cc-tone-mapping");return s.addRenderTarget(t.colorName,C.CLEAR,x.STORE,W),s.addTexture(i,"inputTexture"),s.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,1),s}function v(e,a,t){return e.startsWith(a)?`${a}${1-Number(e.charAt(a.length))}_${t}`:`${a}0_${t}`}class ${constructor(){this.lights=[],this.shadowEnabledSpotLights=[],this._sphere=P.create(0,0,0,1),this._boundingBox=new b,this._rangedDirLightBoundingBox=new b(0,0,0,.5,.5,.5)}cullLights(e,a,t){this.lights.length=0,this.shadowEnabledSpotLights.length=0;for(const t of e.spotLights)t.baked||(P.set(this._sphere,t.position.x,t.position.y,t.position.z,t.range),f.sphereFrustum(this._sphere,a)&&(t.shadowEnabled?this.shadowEnabledSpotLights.push(t):this.lights.push(t)));for(const t of e.sphereLights)t.baked||(P.set(this._sphere,t.position.x,t.position.y,t.position.z,t.range),f.sphereFrustum(this._sphere,a)&&this.lights.push(t));for(const t of e.pointLights)t.baked||(P.set(this._sphere,t.position.x,t.position.y,t.position.z,t.range),f.sphereFrustum(this._sphere,a)&&this.lights.push(t));for(const t of e.rangedDirLights)b.transform(this._boundingBox,this._rangedDirLightBoundingBox,t.node.getWorldMatrix()),f.aabbFrustum(this._boundingBox,a)&&this.lights.push(t);t&&this.shadowEnabledSpotLights.sort(((e,a)=>o.squaredDistance(t,e.position)-o.squaredDistance(t,a.position)))}_addLightQueues(e,a){for(const t of this.lights){const i=a.addQueue(r.QueueHint.BLEND,"forward-add");switch(t.type){case O.SPHERE:i.name="sphere-light";break;case O.SPOT:i.name="spot-light";break;case O.POINT:i.name="point-light";break;case O.RANGED_DIRECTIONAL:i.name="ranged-directional-light";break;default:i.name="unknown-light"}i.addScene(e,r.SceneFlags.BLEND,t)}}addSpotlightShadowPasses(e,a,t){let i=0;for(const s of this.shadowEnabledSpotLights){const o=e.pipelineSceneData.shadows.size,n=e.addRenderPass(o.x,o.y,"default");if(n.name=`SpotLightShadowPass${i}`,n.addRenderTarget(`SpotShadowMap${i}`,C.CLEAR,x.STORE,new R(1,1,1,1)),n.addDepthStencil(`SpotShadowDepth${i}`,C.CLEAR,x.DISCARD),n.addQueue(r.QueueHint.NONE,"shadow-caster").addScene(a,r.SceneFlags.OPAQUE|r.SceneFlags.MASK|r.SceneFlags.SHADOW_CASTER).useLightFrustum(s),++i,i>=t)break}}addLightQueues(e,a,t){this._addLightQueues(a,e);let i=0;for(const s of this.shadowEnabledSpotLights){e.addTexture(`SpotShadowMap${i}`,"cc_spotShadowMap");if(e.addQueue(r.QueueHint.BLEND,"forward-add").addScene(a,r.SceneFlags.BLEND,s),++i,i>=t)break}}addLightPasses(e,a,t,i,s,o,n,d,l,h){this._addLightQueues(n,h);let c=0;const p=l.pipelineSceneData.shadows.size;for(const g of this.shadowEnabledSpotLights){const m=l.addRenderPass(p.x,p.y,"default");m.name="SpotlightShadowPass",m.addRenderTarget(`ShadowMap${i}`,C.CLEAR,x.STORE,new R(1,1,1,1)),m.addDepthStencil(`ShadowDepth${i}`,C.CLEAR,x.DISCARD),m.addQueue(r.QueueHint.NONE,"shadow-caster").addScene(n,r.SceneFlags.OPAQUE|r.SceneFlags.MASK|r.SceneFlags.SHADOW_CASTER).useLightFrustum(g),++c;const u=c===this.shadowEnabledSpotLights.length?t:x.STORE;(h=l.addRenderPass(s,o,"default")).name="SpotlightWithShadowMap",h.setViewport(d),h.addRenderTarget(e,C.LOAD),h.addDepthStencil(a,C.LOAD,u),h.addTexture(`ShadowMap${i}`,"cc_spotShadowMap");h.addQueue(r.QueueHint.BLEND,"forward-add").addScene(n,r.SceneFlags.BLEND,g)}return h}isMultipleLightPassesNeeded(){return this.shadowEnabledSpotLights.length>0}}class U{constructor(){this.forwardLighting=new $,this._viewport=new L,this._clearColor=new R(0,0,0,1),this._reflectionProbeClearColor=new o(0,0,0)}getConfigOrder(){return U.ConfigOrder}getRenderOrder(){return U.RenderOrder}configCamera(e,a,t){t.enableMainLightShadowMap=a.shadowEnabled&&!a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enableMainLightPlanarShadowMap=a.shadowEnabled&&a.usePlanarShadow&&!!e.scene&&!!e.scene.mainLight&&e.scene.mainLight.shadowEnabled,t.enablePlanarReflectionProbe=t.isMainGameWindow||e.cameraUsage===F.SCENE_VIEW||e.cameraUsage===F.GAME_VIEW,t.enableMSAA=t.settings.msaa.enabled&&(!a.isWebGL2||t.remainingPasses>0||!n.ENABLE_WEBGL_ANTIALIAS&&n.ENABLE_TRANSPARENT_CANVAS)&&!t.enableStoreSceneDepth&&!a.isWebGL1,t.enableSingleForwardPass=a.isMobile||t.enableMSAA,++t.remainingPasses}windowResize(e,a,t,i,s,o,n){const d=r.ResourceFlags,l=r.ResourceResidency,h=i.renderWindowId,c=t.settings,p=t.enableShadingScale?Math.max(Math.floor(o*t.shadingScale),1):o,g=t.enableShadingScale?Math.max(Math.floor(n*t.shadingScale),1):n;if(t.enableMSAA&&(t.enableHDR?e.addTexture(`MsaaRadiance${h}`,A.TEX2D,t.radianceFormat,p,g,1,1,1,c.msaa.sampleCount,d.COLOR_ATTACHMENT,l.MEMORYLESS):e.addTexture(`MsaaRadiance${h}`,A.TEX2D,M.RGBA8,p,g,1,1,1,c.msaa.sampleCount,d.COLOR_ATTACHMENT,l.MEMORYLESS),e.addTexture(`MsaaDepthStencil${h}`,A.TEX2D,M.DEPTH_STENCIL,p,g,1,1,1,c.msaa.sampleCount,d.DEPTH_STENCIL_ATTACHMENT,l.MEMORYLESS)),e.addRenderTarget(`ShadowMap${h}`,a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil(`ShadowDepth${h}`,M.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y),t.enableSingleForwardPass){const t=a.mobileMaxSpotLightShadowMaps;for(let i=0;i!==t;++i)e.addRenderTarget(`SpotShadowMap${i}`,a.shadowMapFormat,a.shadowMapSize.x,a.shadowMapSize.y),e.addDepthStencil(`SpotShadowDepth${i}`,M.DEPTH_STENCIL,a.shadowMapSize.x,a.shadowMapSize.y)}}setup(e,a,t,i,s){e.setVec4("g_platform",a.platform);const o=i.window.renderWindowId,n=i.scene,r=n.mainLight;--t.remainingPasses,d(t.remainingPasses>=0),this.forwardLighting.cullLights(n,i.frustum),t.enableMainLightShadowMap&&(d(!!r),this._addCascadedShadowMapPass(e,a,o,r,i)),t.enableSingleForwardPass&&this.forwardLighting.addSpotlightShadowPasses(e,i,a.mobileMaxSpotLightShadowMaps),this._tryAddReflectionProbePasses(e,t,o,r,i.scene),t.remainingPasses>0||t.enableShadingScale?(s.colorName=t.enableShadingScale?`ScaledRadiance0_${o}`:`Radiance0_${o}`,s.depthStencilName=t.enableShadingScale?`ScaledSceneDepth_${o}`:`SceneDepth_${o}`):(s.colorName=t.colorName,s.depthStencilName=t.depthStencilName);const l=this._addForwardRadiancePasses(e,a,t,o,i,t.width,t.height,r,s.colorName,s.depthStencilName,!t.enableMSAA,t.enableStoreSceneDepth?x.STORE:x.DISCARD);return t.enableStoreSceneDepth||(s.depthStencilName=""),0===t.remainingPasses&&t.enableShadingScale?G(e,0,t,s.colorName):l}_addCascadedShadowMapPass(e,a,t,i,s){const o=r.QueueHint,n=r.SceneFlags,d=e.pipelineSceneData.shadows.size,l=d.x,h=d.y,c=this._viewport;c.left=c.top=0,c.width=l,c.height=h;const p=e.addRenderPass(l,h,"default");p.name="CascadedShadowMap",p.addRenderTarget(`ShadowMap${t}`,C.CLEAR,x.STORE,new R(1,1,1,1)),p.addDepthStencil(`ShadowDepth${t}`,C.CLEAR,x.DISCARD);const g=e.pipelineSceneData.csmSupported?i.csmLevel:1;for(let e=0;e!==g;++e){Q(i,l,h,e,this._viewport,a.screenSpaceSignY);const t=p.addQueue(o.NONE,"shadow-caster");a.isWebGPU||t.setViewport(this._viewport),t.addScene(s,n.OPAQUE|n.MASK|n.SHADOW_CASTER).useLightFrustum(i,e)}}_tryAddReflectionProbePasses(e,t,i,o,n){const d=a.internal.reflectionProbeManager;if(!d)return;const h=r.ResourceResidency,c=d.getProbes();let p=0;for(const a of c){if(!a.needRender)continue;const r=a.renderArea(),d=Math.max(Math.floor(r.x),1),c=Math.max(Math.floor(r.y),1);if(a.probeType===l.scene.ProbeType.PLANAR){if(!t.enablePlanarReflectionProbe)continue;const r=a.realtimePlanarTexture.window,l=`PlanarProbeRT${p}`,g=`PlanarProbeDS${p}`;e.addRenderWindow(l,t.radianceFormat,d,c,r),e.addDepthStencil(g,s.Format.DEPTH_STENCIL,d,c,h.MEMORYLESS);const m=e.addRenderPass(d,c,"default");m.name=`PlanarReflectionProbe${p}`,this._buildReflectionProbePass(m,t,i,a.camera,l,g,o,n)}if(++p,4===p)break}}_buildReflectionProbePass(e,a,t,i,s,o,n,d=null){const l=r.QueueHint,h=r.SceneFlags,c=a.enableMSAA?x.DISCARD:x.STORE;if(B(i)){this._reflectionProbeClearColor.x=i.clearColor.x,this._reflectionProbeClearColor.y=i.clearColor.y,this._reflectionProbeClearColor.z=i.clearColor.z;const a=r.packRGBE(this._reflectionProbeClearColor);this._clearColor.x=a.x,this._clearColor.y=a.y,this._clearColor.z=a.z,this._clearColor.w=a.w,e.addRenderTarget(s,C.CLEAR,c,this._clearColor)}else e.addRenderTarget(s,C.LOAD,c);i.clearFlag&T.DEPTH_STENCIL?e.addDepthStencil(o,C.CLEAR,x.DISCARD,i.clearDepth,i.clearStencil,i.clearFlag&T.DEPTH_STENCIL):e.addDepthStencil(o,C.LOAD,x.DISCARD),a.enableMainLightShadowMap&&e.addTexture(`ShadowMap${t}`,"cc_shadowMap"),e.addQueue(l.NONE,"reflect-map").addScene(i,h.OPAQUE|h.MASK|h.REFLECTION_PROBE,n||void 0,d||void 0)}_addForwardRadiancePasses(e,a,t,i,s,o,n,l,h,c,p=!1,g=x.DISCARD){const m=r.QueueHint,u=r.SceneFlags,S=s.clearColor;this._clearColor.x=S.x,this._clearColor.y=S.y,this._clearColor.z=S.z,this._clearColor.w=S.w;const _=s.viewport;this._viewport.left=Math.round(_.x*o),this._viewport.top=Math.round(_.y*n),this._viewport.width=Math.max(Math.round(_.width*o),1),this._viewport.height=Math.max(Math.round(_.height*n),1);const w=!p&&t.enableMSAA;d(!w||t.enableSingleForwardPass);const b=t.enableSingleForwardPass?this._addForwardSingleRadiancePass(e,a,t,i,s,w,o,n,l,h,c,g):this._addForwardMultipleRadiancePasses(e,t,i,s,o,n,l,h,c,g);t.enableMainLightPlanarShadowMap&&this._addPlanarShadowQueue(s,l,b);const P=u.BLEND|(s.geometryRenderer?u.GEOMETRY:u.NONE);return b.addQueue(m.BLEND).addScene(s,P,l||void 0),b}_addForwardSingleRadiancePass(e,a,t,i,s,o,n,r,l,h,c,p){let g;if(d(t.enableSingleForwardPass),o){const a=`MsaaRadiance${i}`,o=`MsaaDepthStencil${i}`,d=t.settings.msaa.sampleCount,c=e.addMultisampleRenderPass(n,r,d,0,"default");c.name="MsaaForwardPass",this._buildForwardMainLightPass(c,t,i,s,a,o,x.DISCARD,l),c.resolveRenderTarget(a,h),g=c}else g=e.addRenderPass(n,r,"default"),g.name="ForwardPass",this._buildForwardMainLightPass(g,t,i,s,h,c,p,l);return d(void 0!==g),this.forwardLighting.addLightQueues(g,s,a.mobileMaxSpotLightShadowMaps),g}_addForwardMultipleRadiancePasses(e,a,t,i,s,o,n,r,l,h){d(!a.enableSingleForwardPass);let c=e.addRenderPass(s,o,"default");c.name="ForwardPass";const p=this.forwardLighting.isMultipleLightPassesNeeded()?x.STORE:h;return this._buildForwardMainLightPass(c,a,t,i,r,l,p,n),c=this.forwardLighting.addLightPasses(r,l,h,t,s,o,i,this._viewport,e,c),c}_buildForwardMainLightPass(e,a,t,i,s,o,n,d,l=null){const h=r.QueueHint,c=r.SceneFlags;e.setViewport(this._viewport);const p=a.enableMSAA?x.DISCARD:x.STORE;B(i)?e.addRenderTarget(s,C.CLEAR,p,this._clearColor):e.addRenderTarget(s,C.LOAD,p),i.clearFlag&T.DEPTH_STENCIL?e.addDepthStencil(o,C.CLEAR,n,i.clearDepth,i.clearStencil,i.clearFlag&T.DEPTH_STENCIL):e.addDepthStencil(o,C.LOAD,n),a.enableMainLightShadowMap&&e.addTexture(`ShadowMap${t}`,"cc_shadowMap"),e.addQueue(h.NONE).addScene(i,c.OPAQUE|c.MASK,d||void 0,l||void 0)}_addPlanarShadowQueue(e,a,t){const i=r.QueueHint,s=r.SceneFlags;t.addQueue(i.BLEND,"planar-shadow").addScene(e,s.SHADOW_CASTER|s.PLANAR_SHADOW|s.BLEND,a||void 0)}}function V(e,a){return Math.max(Math.floor(e*a),1)}e("BuiltinForwardPassBuilder",U),U.ConfigOrder=100,U.RenderOrder=100;class k{constructor(){this._clearColorTransparentBlack=new R(0,0,0,0),this._bloomParams=new i(0,0,0,0),this._bloomTexSize=new i(0,0,0,0),this._bloomWidths=[],this._bloomHeights=[],this._bloomTexNames=[],this._bloomUpSampleTexDescs=[],this._bloomDownSampleTexDescs=[],this._prefilterTexDesc={name:"",width:0,height:0},this._originalColorDesc={name:"",width:0,height:0}}getConfigOrder(){return 0}getRenderOrder(){return 200}configCamera(e,a,t){const{bloom:i}=t.settings,s=i.type===w.KawaseDualFilter&&!!i.kawaseFilterMaterial||i.type===w.MipmapFilter&&!!i.mipmapFilterMaterial;t.enableBloom=i.enabled&&s,t.enableBloom&&++t.remainingPasses}windowResize(e,a,t,i){if(!t.enableBloom)return;const{width:s,height:o,settings:{bloom:n}}=t,r=i.renderWindowId,d=t.radianceFormat;if(n.type===w.KawaseDualFilter){let a=t.width,i=t.height;for(let t=0;t!==n.iterations+1;++t)a=Math.max(Math.floor(a/2),1),i=Math.max(Math.floor(i/2),1),e.addRenderTarget(`BloomTex${r}_${t}`,d,a,i)}else if(n.type===w.MipmapFilter){const a=n.iterations;for(let t=0;t!==a+1;++t){if(t<a){const a=Math.pow(.5,t+2);this._bloomDownSampleTexDescs[t]=this.createTexture(e,`DownSampleColor${r}${t}`,V(s,a),V(o,a),d)}if(t<a-1){const i=Math.pow(.5,a-t-1);this._bloomUpSampleTexDescs[t]=this.createTexture(e,`UpSampleColor${r}${t}`,V(s,i),V(o,i),d)}}this._originalColorDesc=this.createTexture(e,`OriginalColor${r}`,s,o,d),this._prefilterTexDesc=this.createTexture(e,`PrefilterColor${r}`,V(s,.5),V(o,.5),d)}}createTexture(e,a,t,i,s){const o={name:a,width:t,height:i};return e.addRenderTarget(o.name,s,o.width,o.height),o}setup(e,a,t,i,s,o){if(!t.enableBloom)return o;--t.remainingPasses,d(t.remainingPasses>=0);const n=t.settings.bloom,r=i.window.renderWindowId;switch(n.type){case w.KawaseDualFilter:{const i=n.kawaseFilterMaterial;return d(!!i),this._addKawaseDualFilterBloomPasses(e,a,t,t.settings,i,r,t.width,t.height,s.colorName)}case w.MipmapFilter:{const i=n.mipmapFilterMaterial;return d(!!i),this._addMipmapFilterBloomPasses(e,a,t,t.settings,i,r,t.width,t.height,s.colorName)}default:return o}}_addKawaseDualFilterBloomPasses(e,a,t,i,s,o,n,d,l){const h=r.QueueHint,c=i.bloom.iterations,p=c+1;this._bloomWidths.length=p,this._bloomHeights.length=p,this._bloomWidths[0]=Math.max(Math.floor(n/2),1),this._bloomHeights[0]=Math.max(Math.floor(d/2),1);for(let e=1;e!==p;++e)this._bloomWidths[e]=Math.max(Math.floor(this._bloomWidths[e-1]/2),1),this._bloomHeights[e]=Math.max(Math.floor(this._bloomHeights[e-1]/2),1);this._bloomTexNames.length=p;for(let e=0;e!==p;++e)this._bloomTexNames[e]=`BloomTex${o}_${e}`;this._bloomParams.x=a.useFloatOutput?1:0,this._bloomParams.y=0,this._bloomParams.z=i.bloom.threshold,this._bloomParams.w=i.bloom.enableAlphaMask?1:0;const g=e.addRenderPass(this._bloomWidths[0],this._bloomHeights[0],"cc-bloom-prefilter");g.addRenderTarget(this._bloomTexNames[0],C.CLEAR,x.STORE,this._clearColorTransparentBlack),g.addTexture(l,"inputTexture"),g.setVec4("bloomParams",this._bloomParams),g.addQueue(h.OPAQUE).addFullscreenQuad(s,0);for(let a=1;a!==p;++a){const t=e.addRenderPass(this._bloomWidths[a],this._bloomHeights[a],"cc-bloom-downsample");t.addRenderTarget(this._bloomTexNames[a],C.CLEAR,x.STORE,this._clearColorTransparentBlack),t.addTexture(this._bloomTexNames[a-1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[a-1],this._bloomTexSize.y=this._bloomHeights[a-1],t.setVec4("bloomTexSize",this._bloomTexSize),t.addQueue(h.OPAQUE).addFullscreenQuad(s,1)}for(let a=c;a-- >0;){const t=e.addRenderPass(this._bloomWidths[a],this._bloomHeights[a],"cc-bloom-upsample");t.addRenderTarget(this._bloomTexNames[a],C.CLEAR,x.STORE,this._clearColorTransparentBlack),t.addTexture(this._bloomTexNames[a+1],"bloomTexture"),this._bloomTexSize.x=this._bloomWidths[a+1],this._bloomTexSize.y=this._bloomHeights[a+1],t.setVec4("bloomTexSize",this._bloomTexSize),t.addQueue(h.OPAQUE).addFullscreenQuad(s,2)}this._bloomParams.w=i.bloom.intensity;const m=e.addRenderPass(n,d,"cc-bloom-combine");return m.addRenderTarget(l,C.LOAD,x.STORE),m.addTexture(this._bloomTexNames[0],"bloomTexture"),m.setVec4("bloomParams",this._bloomParams),m.addQueue(h.BLEND).addFullscreenQuad(s,3),0===t.remainingPasses?G(e,0,t,l):m}_addPass(e,a,t,i,s,o,n,d=C.CLEAR,l=W,h=r.QueueHint.OPAQUE){const c=e.addRenderPass(a,t,i);return c.addRenderTarget(s,d,x.STORE,l),c.addQueue(h).addFullscreenQuad(o,n),c}_addMipmapFilterBloomPasses(e,a,t,i,s,o,n,r,d){this._bloomParams.x=a.useFloatOutput?1:0,this._bloomParams.x=0,this._bloomParams.z=i.bloom.threshold,this._bloomParams.w=i.bloom.intensity;const l=this._prefilterTexDesc;let h=this._addPass(e,l.width,l.height,"cc-bloom-mipmap-prefilter",l.name,s,0);h.addTexture(d,"mainTexture"),h.setVec4("bloomParams",this._bloomParams);const c=this._bloomDownSampleTexDescs;for(let a=0;a<c.length;++a){const t=c[a],i=0===a?l:c[a-1],o=i.name;this._bloomTexSize.x=1/i.width,this._bloomTexSize.y=1/i.height,h=this._addPass(e,t.width,t.height,"cc-bloom-mipmap-downsample",t.name,s,1),h.addTexture(o,"mainTexture"),h.setVec4("bloomParams",this._bloomTexSize)}const p=c.length-1,g=this._bloomUpSampleTexDescs;for(let a=0;a<g.length;a++){const t=g[a],i=0===a?c[p]:g[a-1],o=i.name;this._bloomTexSize.x=1/i.width,this._bloomTexSize.y=1/i.height,h=this._addPass(e,t.width,t.height,"cc-bloom-mipmap-upsample",t.name,s,2),h.addTexture(o,"mainTexture"),h.addTexture(c[p-1-a].name,"downsampleTexture"),h.setVec4("bloomParams",this._bloomTexSize)}const m=this._addPass(e,n,r,"cc-bloom-mipmap-combine",d,s,3,C.LOAD);return m.addTexture(g[g.length-1].name,"bloomTexture"),m.setVec4("bloomParams",this._bloomParams),0===t.remainingPasses?G(e,0,t,d):m}}e("BuiltinBloomPassBuilder",k);class Y{constructor(){this._colorGradingTexSize=new t(0,0)}getConfigOrder(){return 0}getRenderOrder(){return 300}configCamera(e,a,t){const i=t.settings;t.enableColorGrading=i.colorGrading.enabled&&!!i.colorGrading.material&&!!i.colorGrading.colorGradingMap,t.enableToneMapping=t.enableHDR||t.enableColorGrading,t.enableToneMapping&&++t.remainingPasses}windowResize(e,a,t){t.enableColorGrading&&(d(!!t.settings.colorGrading.material),t.settings.colorGrading.material.setProperty("colorGradingMap",t.settings.colorGrading.colorGradingMap))}setup(e,a,t,i,s,o){if(!t.enableToneMapping)return o;if(--t.remainingPasses,d(t.remainingPasses>=0),0===t.remainingPasses)return this._addCopyAndTonemapPass(e,a,t,t.width,t.height,s.colorName,t.colorName);{const i=t.renderWindowId,o=t.enableShadingScale?"ScaledLdrColor":"LdrColor",n=v(s.colorName,o,i),r=s.colorName;return s.colorName=n,this._addCopyAndTonemapPass(e,a,t,t.width,t.height,r,n)}}_addCopyAndTonemapPass(e,a,t,i,s,o,n){let l;const h=t.settings;if(t.enableColorGrading){d(!!h.colorGrading.material),d(!!h.colorGrading.colorGradingMap);const a=h.colorGrading.colorGradingMap;this._colorGradingTexSize.x=a.width,this._colorGradingTexSize.y=a.height;const t=a.width===a.height;l=t?e.addRenderPass(i,s,"cc-color-grading-8x8"):e.addRenderPass(i,s,"cc-color-grading-nx1"),l.addRenderTarget(n,C.CLEAR,x.STORE,W),l.addTexture(o,"sceneColorMap"),l.setVec2("lutTextureSize",this._colorGradingTexSize),l.setFloat("contribute",h.colorGrading.contribute),l.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(h.colorGrading.material,t?1:0)}else l=e.addRenderPass(i,s,"cc-tone-mapping"),l.addRenderTarget(n,C.CLEAR,x.STORE,W),l.addTexture(o,"inputTexture"),h.toneMapping.material?l.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(h.toneMapping.material,0):(d(!!t.copyAndTonemapMaterial),l.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(t.copyAndTonemapMaterial,0));return l}}e("BuiltinToneMappingPassBuilder",Y);class K{constructor(){this._fxaaParams=new i(0,0,0,0)}getConfigOrder(){return 0}getRenderOrder(){return 400}configCamera(e,a,t){t.enableFXAA=t.settings.fxaa.enabled&&!!t.settings.fxaa.material,t.enableFXAA&&++t.remainingPasses}setup(e,a,t,i,s,o){if(!t.enableFXAA)return o;--t.remainingPasses,d(t.remainingPasses>=0);const n=t.renderWindowId,r=t.enableShadingScale?"ScaledLdrColor":"LdrColor",l=v(s.colorName,r,n);if(d(!!t.settings.fxaa.material),0===t.remainingPasses)return t.enableShadingScale?(this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,s.colorName,l),G(e,0,t,l)):(d(t.width===t.nativeWidth),d(t.height===t.nativeHeight),this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,s.colorName,t.colorName));{const i=s.colorName;s.colorName=l;return this._addFxaaPass(e,a,t.settings.fxaa.material,t.width,t.height,i,l)}}_addFxaaPass(e,a,t,i,s,o,n){this._fxaaParams.x=i,this._fxaaParams.y=s,this._fxaaParams.z=1/i,this._fxaaParams.w=1/s;const d=e.addRenderPass(i,s,"cc-fxaa");return d.addRenderTarget(n,C.CLEAR,x.STORE,W),d.addTexture(o,"sceneColorMap"),d.setVec4("texSize",this._fxaaParams),d.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(t,0),d}}e("BuiltinFXAAPassBuilder",K);class X{constructor(){this._fsrParams=new i(0,0,0,0),this._fsrTexSize=new i(0,0,0,0)}getConfigOrder(){return 0}getRenderOrder(){return 500}configCamera(e,a,t){t.enableFSR=t.settings.fsr.enabled&&!!t.settings.fsr.material&&t.enableShadingScale&&t.shadingScale<1,t.enableFSR&&++t.remainingPasses}setup(e,a,t,i,s,o){if(!t.enableFSR)return o;--t.remainingPasses;const n=s.colorName,r=0===t.remainingPasses?t.colorName:v(s.colorName,"UiColor",t.renderWindowId);return s.colorName=r,d(!!t.settings.fsr.material),this._addFsrPass(e,a,t,t.settings,t.settings.fsr.material,t.renderWindowId,t.width,t.height,n,t.nativeWidth,t.nativeHeight,r)}_addFsrPass(e,a,t,i,s,o,n,d,l,c,p,g){this._fsrTexSize.x=n,this._fsrTexSize.y=d,this._fsrTexSize.z=c,this._fsrTexSize.w=p,this._fsrParams.x=h(1-i.fsr.sharpness,.02,.98);const m=v(g,"UiColor",o),u=e.addRenderPass(c,p,"cc-fsr-easu");u.addRenderTarget(m,C.CLEAR,x.STORE,W),u.addTexture(l,"outputResultMap"),u.setVec4("fsrTexSize",this._fsrTexSize),u.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(s,0);const S=e.addRenderPass(c,p,"cc-fsr-rcas");return S.addRenderTarget(g,C.CLEAR,x.STORE,W),S.addTexture(m,"outputResultMap"),S.setVec4("fsrTexSize",this._fsrTexSize),S.setVec4("fsrParams",this._fsrParams),S.addQueue(r.QueueHint.OPAQUE).addFullscreenQuad(s,1),S}}e("BuiltinFsrPassBuilder",X);class q{getConfigOrder(){return 0}getRenderOrder(){return 1e3}setup(e,a,t,i,s,o){d(!!o);let n=r.SceneFlags.UI;return t.enableProfiler&&(n|=r.SceneFlags.PROFILER,o.showStatistics=!0),o.addQueue(r.QueueHint.BLEND,"default","default").addScene(i,n),o}}if(e("BuiltinUiPassBuilder",q),r){const{QueueHint:e,SceneFlags:t}=r;class i{constructor(){this._pipelineEvent=a.director.root.pipelineEvent,this._forwardPass=new U,this._bloomPass=new k,this._toneMappingPass=new Y,this._fxaaPass=new K,this._fsrPass=new X,this._uiPass=new q,this._clearColor=new R(0,0,0,1),this._viewport=new L,this._configs=new y,this._cameraConfigs=new I,this._copyAndTonemapMaterial=new c,this._initialized=!1,this._passBuilders=[]}_setupPipelinePreview(e,a){if(e.cameraUsage===F.SCENE_VIEW||e.cameraUsage===F.PREVIEW){const e=r.getEditorPipelineSettings();a.settings=e||H}else e.pipelineSettings?a.settings=e.pipelineSettings:a.settings=H}_preparePipelinePasses(e){const a=this._passBuilders;a.length=0;const t=e.settings;if(t._passes){for(const e of t._passes)a.push(e);d(a.length===t._passes.length)}a.push(this._forwardPass),t.bloom.enabled&&a.push(this._bloomPass),a.push(this._toneMappingPass),t.fxaa.enabled&&a.push(this._fxaaPass),t.fsr.enabled&&a.push(this._fsrPass),a.push(this._uiPass)}_setupBuiltinCameraConfigs(e,a,t,i){const o=a.window,n=a.cameraUsage===F.GAME&&!!o.swapchain,r=n||a.cameraUsage===F.GAME_VIEW;i.isMainGameWindow=n,i.renderWindowId=o.renderWindowId,i.colorName=o.colorName,i.depthStencilName=o.depthStencilName,i.enableFullPipeline=0!=(a.visibility&p.Enum.DEFAULT),i.enableProfiler=e.profiler&&r,i.remainingPasses=0,i.shadingScale=i.settings.shadingScale,i.enableShadingScale=i.settings.enableShadingScale&&1!==i.shadingScale,i.nativeWidth=Math.max(Math.floor(o.width),1),i.nativeHeight=Math.max(Math.floor(o.height),1),i.width=i.enableShadingScale?Math.max(Math.floor(i.nativeWidth*i.shadingScale),1):i.nativeWidth,i.height=i.enableShadingScale?Math.max(Math.floor(i.nativeHeight*i.shadingScale),1):i.nativeHeight,i.enableHDR=i.enableFullPipeline&&t.useFloatOutput,i.radianceFormat=i.enableHDR?s.Format.RGBA16F:s.Format.RGBA8,i.copyAndTonemapMaterial=this._copyAndTonemapMaterial,i.enableStoreSceneDepth=!1}_setupCameraConfigs(e,a,t,i){this._setupPipelinePreview(a,i),this._preparePipelinePasses(i),this._passBuilders.sort(((e,a)=>e.getConfigOrder()-a.getConfigOrder())),this._setupBuiltinCameraConfigs(e,a,t,i);for(const e of this._passBuilders)e.configCamera&&e.configCamera(a,t,i)}windowResize(e,a,t,i,s){z(e,this._configs),this._setupCameraConfigs(e,t,this._configs,this._cameraConfigs);const o=a.renderWindowId;e.addRenderWindow(this._cameraConfigs.colorName,M.RGBA8,i,s,a,this._cameraConfigs.depthStencilName);const n=this._cameraConfigs.width,r=this._cameraConfigs.height;this._cameraConfigs.enableShadingScale?(e.addDepthStencil(`ScaledSceneDepth_${o}`,M.DEPTH_STENCIL,n,r),e.addRenderTarget(`ScaledRadiance0_${o}`,this._cameraConfigs.radianceFormat,n,r),e.addRenderTarget(`ScaledRadiance1_${o}`,this._cameraConfigs.radianceFormat,n,r),e.addRenderTarget(`ScaledLdrColor0_${o}`,M.RGBA8,n,r),e.addRenderTarget(`ScaledLdrColor1_${o}`,M.RGBA8,n,r)):(e.addDepthStencil(`SceneDepth_${o}`,M.DEPTH_STENCIL,n,r),e.addRenderTarget(`Radiance0_${o}`,this._cameraConfigs.radianceFormat,n,r),e.addRenderTarget(`Radiance1_${o}`,this._cameraConfigs.radianceFormat,n,r),e.addRenderTarget(`LdrColor0_${o}`,M.RGBA8,n,r),e.addRenderTarget(`LdrColor1_${o}`,M.RGBA8,n,r)),e.addRenderTarget(`UiColor0_${o}`,M.RGBA8,i,s),e.addRenderTarget(`UiColor1_${o}`,M.RGBA8,i,s);for(const o of this._passBuilders)o.windowResize&&o.windowResize(e,this._configs,this._cameraConfigs,a,t,i,s)}setup(e,a){if(!this._initMaterials(a))for(const t of e)t.scene&&t.window&&(this._setupCameraConfigs(a,t,this._configs,this._cameraConfigs),this._pipelineEvent.emit(g.RENDER_CAMERA_BEGIN,t),this._cameraConfigs.enableFullPipeline?this._buildForwardPipeline(a,t,t.scene,this._passBuilders):this._buildSimplePipeline(a,t),this._pipelineEvent.emit(g.RENDER_CAMERA_END,t))}_buildSimplePipeline(a,i){const s=Math.max(Math.floor(i.window.width),1),o=Math.max(Math.floor(i.window.height),1),n=this._cameraConfigs.colorName,r=this._cameraConfigs.depthStencilName,d=i.viewport;this._viewport.left=Math.round(d.x*s),this._viewport.top=Math.round(d.y*o),this._viewport.width=Math.max(Math.round(d.width*s),1),this._viewport.height=Math.max(Math.round(d.height*o),1);const l=i.clearColor;this._clearColor.x=l.x,this._clearColor.y=l.y,this._clearColor.z=l.z,this._clearColor.w=l.w;const h=a.addRenderPass(s,o,"default");B(i)?h.addRenderTarget(n,C.CLEAR,x.STORE,this._clearColor):h.addRenderTarget(n,C.LOAD,x.STORE),i.clearFlag&T.DEPTH_STENCIL?h.addDepthStencil(r,C.CLEAR,x.DISCARD,i.clearDepth,i.clearStencil,i.clearFlag&T.DEPTH_STENCIL):h.addDepthStencil(r,C.LOAD,x.DISCARD),h.setViewport(this._viewport),h.addQueue(e.OPAQUE).addScene(i,t.OPAQUE);let c=t.BLEND|t.UI;this._cameraConfigs.enableProfiler&&(c|=t.PROFILER,h.showStatistics=!0),h.addQueue(e.BLEND).addScene(i,c)}_buildForwardPipeline(e,a,t,i){!function(e){e.sort(((e,a)=>e.getRenderOrder()-a.getRenderOrder()))}(i);const s={colorName:"",depthStencilName:""};let o;for(const t of i)t.setup&&(o=t.setup(e,this._configs,this._cameraConfigs,a,s,o));d(0===this._cameraConfigs.remainingPasses)}_initMaterials(e){return this._initialized?0:(z(e,this._configs),this._copyAndTonemapMaterial._uuid="builtin-pipeline-tone-mapping-material",this._copyAndTonemapMaterial.initialize({effectName:"pipeline/post-process/tone-mapping"}),this._copyAndTonemapMaterial.effectAsset&&(this._initialized=!0),this._initialized?0:1)}}r.setCustomPipeline("Builtin",new i)}a._RF.pop()}}}));

System.register("chunks:///_virtual/internal",["./builtin-pipeline-settings.ts","./builtin-pipeline-types.ts","./builtin-pipeline.ts"],(function(){return{setters:[null,null,null],execute:function(){}}}));

(function(r) {
  r('virtual:///prerequisite-imports/internal', 'chunks:///_virtual/internal'); 
})(function(mid, cid) {
    System.register(mid, [cid], function (_export, _context) {
    return {
        setters: [function(_m) {
            var _exportObj = {};

            for (var _key in _m) {
              if (_key !== "default" && _key !== "__esModule") _exportObj[_key] = _m[_key];
            }
      
            _export(_exportObj);
        }],
        execute: function () { }
    };
    });
});